<% if @metadata %>
	<% content_for :metadata do %>
		<%= render partial: "view/meta", locals: @metadata %>
	<% end %>
<% end %>
<section class="page column-left">
	<div id="video" style="background-image: url('/cover/<%= @video.id %>.png');" data-time="<%= @time %>" data-title="<%= @video.getTitle %>" data-artist="<%= @user.username %>" data-<% if @video.audio_only %>audio<% else %>video<% end %>="<%= @video.id %>" data-mime="<%= @video.file %>|<%= @video.mime %>" <%if @album %>data-autoplay="true"<% end %> class="video"></div>
	<span class="notices">
	<% if !@video.processed %>
		<div class="notice pending">This video is still being processed by our background ponies. If it does not play correctly try again later.</div>
	<% end %>
	<% if @video.hidden %>
		<div class="notice alert">This video has been hidden. It will not be shown on other parts of the site until being passed by moderation.</div>
	<% end %>
	</span>
	<div class="post description resize-holder">
	<% if @modificationsAllowed %>
		<h2 class="title editable post-title resize-target short" data-target="video" data-member="title" data-id="<%= @video.id %>">
			<span class="content "><%= @video.title %></span>
			<span class="edit"><i class="fa fa-pencil"></i></span>
			<span style="display:none">11</span>
		</h2>
	<% else %>
		<h2 class="title post-title resize-target short">
			<span class="content "><%= @video.title %></span>
		</h2>
	<% end %>
		<div class="tag-list subheading">
			<span class="uploaded">Uploaded on <%= @video.created_at.to_time.strftime('%e %B %Y') %> by <%= @user.username %></span>
			<span class="views right"><%= number_with_delimiter @video.views %> views</span>
		</div>
	<% if @modificationsAllowed %>
		<span class="editable post-content" data-target="video" data-member="description" data-id="<%= @video.id %>">
			<span class="content"><%= raw @video.html_description %></span>
			<span class="edit"><i class="fa fa-pencil" ></i></span>
		</span>
	<% else %>
		<span class="post-content">
			<span class="content"><%= raw @video.html_description %></span>
		</span>
	<% end %>
		<div class="post-tags">
			<div class="normal tiny-link">
				Source: <a href="<%= @video.get_source %>"><%= @video.source %></a>
			</div>
			<div class="normal tags">
				<%= render partial: '/layouts/genre_thumb_h', collection: @tags %>
			</div>
		<% if user_signed_in? %>
			<%= form_for(@video, as: "video", url: "ajax/video/edit", html: {class: "editing async form-state-toggle", "data-state": "editing"}) do |f| %>
				<%= f.text_field :id, hidden: true %>
				<%= render layout: 'layouts/tageditor', locals: {tags: @video.tags} do %>
					<textarea name="tags"><%= raw @video.tag_string %></textarea>
				<% end %>
				<div class="properties">
					<table>
						<tr>
							<td class="label"><label for="video_source">Source</label></td>
							<td class="field">
								<input class="input" name="source" type="text">
							</td>
						</tr>
						<tr>
							<td class="label">
							</td>
							<td class="field">
								<button class="form-submitter">Save Changes</button>
								<button type="button" onclick="$(this).parents('.post-tags').toggleClass('editing')">Close</button>
							</td>
						</tr>
					</table>
				</div>
			<% end %>
			<hr class="normal">
			<button class="normal state-toggle" data-state="editing">Edit Tags Or Source</button>
		<% end %>
		</div>
		<div class="actions">
			<div class="split-button popper">
				<button class="action options mobile-friendly pop-out-toggle"><i class="fa fa-gear"></i> <span>Options</span></button>
				<ul class="pop-out">
				<% if user_signed_in? && current_user.is_contributor? %>
					<li class="action">
						<a href="/admin/video/<%= @video.id %>">
							<span class="icon"><i class="fa fa-gavel"></i></span>
							<span class="label">Admin</span>
						</a>
					</li>
				<% end %>
				<% if @modificationsAllowed %>
					<li class="action">
						<a href="/video/edit/<%= @video.id %>">
							<span class="icon"><i class="fa fa-pencil"></i></span>
							<span class="label">Change Cover Image</span>
						</a>
					</li>
				<% end %>
					<li class="action">
						<a download target="_blank" href="/download/<%= @video.id %>">
							<span class="icon">
								<i class="fa fa-download"></i>
							</span>
							<span class="label">Download</span>
						</a>
					</li>
					<li class="action">
						<a href="/video/<%= @video.id %>/changes">
							<span class="icon">
								<i class="fa fa-history"></i>
							</span>
							<span class="label">Tag Changes</span>
						</a>
					</li>
				</ul>
			</div>
			<button class="action share mobile-friendly slider-toggle" data-target=".slideout.share"><i class="fa fa-share"></i><span> Share</span></button>
		<% if user_signed_in? %>
			<div class="split-button popper">
				<button class="action star split-icon<% if @video.isStarredBy(current_user) %> starred<% end %>" data-action="star" data-id="<%= @video.id %>">
					<i class="fa fa-star"></i>
				</button>
				<a class="button action addto split-action pop-out-toggle">Add To</a>
				<ul class="pop-out">
					<li class="action confirm-button" data-url="album/create?initial=<%= @video.id %>" data-title="New Album" data-icon="">
						<span class="icon">
							<i class="fa fa-pencil"></i>
						</span>
						<span class="label">
							New Album
						</span>
					</li>
					<% current_user.albums.each do |album| %>
					<li class="action toggle" data-action="togglealbum" data-target="video" data-id="<%= @video.id %>" data-item="<%= album.id %>">
						<span class="icon">
						<% if album.album_items.where(video_id: @video.id).first %>
							<i class="fa fa-check"></i>
						<% end %>
						</span>
						<span class="label">
							<%= album.title %>
						</span>
					</li>
					<% end %>
				</ul>
			</div>
			<button class="action like<% if @video.isUpvotedBy(current_user) %> liked<% end %>" data-count="<%= @video.upvotes %>" data-action="like" data-id="<%= @video.id %>">
				<i class="fa fa-thumbs-up"></i>
				<% if @video.upvotes && @video.upvotes > 0 %>
				<span> (<span class="count"><%= @video.upvotes %></span>)</span>
				<% end %>
			</button>
			<button class="action dislike<% if @video.isDownvotedBy(current_user) %> liked<% end %>" data-count="<%= @video.downvotes %>" data-action="dislike" data-id="<%= @video.id %>">
				<i class="fa fa-thumbs-down"></i>
				<% if @video.downvotes && @video.downvotes > 0 %>
				<span> (<span class="count"><%= @video.downvotes %></span>)</span>
				<% end %>
			</button>
		<% else %>
			<a target="_blank" href="/users/sign_in" class="button action star"><i class="fa fa-star"></i></a>
			<a target="_blank" href="/users/sign_in" class="button action like">
				<i class="fa fa-thumbs-up"></i>
				<span>
					<% if @video.upvotes && @video.upvotes > 0 %>
						<span class="count"><%= @video.upvotes %></span>
					<% end %>
				</span>
			</a>
			<a target="_blank" href="/users/sign_in" class="button action dislike">
				<i class="fa fa-thumbs-down"></i>
				<span>
					<% if @video.downvotes && @video.downvotes > 0 %>
						<span class="count"><%= @video.downvotes %></span>
					<% end %>
				</span>
			</a>
		<% end %>
			<button class="action report mobile-friendly right slider-toggle loadable" data-url="reporter/<%= @video.id %>" data-target=".form.report"><i class="fa fa-flag"></i><span> Report</span></button>
		</div>
		<div class="slideout form report slide-group" data-offset="0"></div>
		<div class="slideout share properties">
			<table class="group active">
				<tr>
					<td class="label">Social</td>
					<td class="field share-buttons" data-caption="<%= @video.title %> - ProjectVinyl">
						<button class="action" data-action="share" data-type="facebook"><i class="fa fa-lg fa-fw fa-facebook"></i></button>
						<button class="action" data-action="share" data-type="twitter"><i class="fa fa-lg fa-fw fa-twitter"></i></button>
						<button class="action" data-action="share" data-type="googleplus"><i class="fa fa-lg fa-fw fa-google-plus"></i></button>
						<button class="action" data-action="share" data-type="tumblr"><i class="fa fa-lg fa-fw fa-tumblr"></i></button>
					</td>
				</tr>
				<tr>
					<td class="label">Embed</td>
					<td class="field">
						<input id="share_field" name="share_field" type="text" data-value="<%= '<iframe width="560" height="315" src="http://www.projectvinyl.net/embed/{id}{extra}" frameborder="0" allowfullscreen></iframe>' %>" value="<%= '<iframe width="560" height="315" src="http://www.projectvinyl.net/embed/' + @video.id.to_s + '" frameborder="0" allowfullscreen></iframe>' %>"></input>
						<% if @album && !@album.virtual? %><div>
							<input id="album_share_toggle" type="checkbox" value="playlist"></input>
							Share with playlist from the
							<select id="album_share_type">
								<option>current video</option>
								<option>beginning</option>
							</select>.
						</div><% end %>
					</td>
				</tr>
				<tr>
					<td class="label"></td>
					<td class="field">
						<div id="embed_preview" class="center" style="display:none;height:315px">
							<iframe style="max-width:100%;" width="560px" height="100%" frameborder="0"></iframe>
						</div>
						<button class="action test center" data-id="<%= @video.id %>"<% if @album %> data-first="<%= @items.length > 1 ? @items.first.video_id : @video.id %>" data-index="<%= @index %>" data-album-id="<%= @album.id %>"<% end %>>Preview</button>
					</td>
				</tr>
				<tr>
					<td class="label">Embed Codes</td>
					<td class="field">
						Projectvinyl preview
						<p>
							<input type="text" value="[<%= @video.id %>]"></input>
						</p>
						BBCode
						<p>
							<textarea rows="2">[url=http://wwww.projectvinyl.net/<%= @video.id %>][img]http://www.projectvinyl.net/cover/<%= @video.id %>-small.png[/img]<%= @video.title.strip %>[/url]</textarea>
						</p>
					</td>
				</tr>
			</table>
		</div>
		<script>
(function() {
  $('.action.test').on('click', function() {
    $('#embed_preview').css('display', '');
    updateShareIframe();
    slideOut(slideOut($(this).closest('.slideout')));
  });
  $('#album_share_toggle, #album_share_type').on('change', function() {
    updateShareIframe();
  });
	function updateShareIframe() {
		var toggle = $('#album_share_toggle');
		var type = $('#album_share_type').val();
		var share_field = $('#share_field');
		var htm = share_field.attr('data-value');
		var button = $('.action.test');
		var id = button.attr(toggle.length && toggle[0].checked && type == 'beginning' ? 'data-first' : 'data-id');
		console.log(id);
		var extra = '';
		if (toggle.length && toggle[0].checked) {
			extra += '?list=' + button.attr('data-album-id') + '&index='
			extra += type == 'beginning' ? 0 : button.attr('data-index');
		}
		htm = htm.replace('{id}', id);
		htm = htm.replace('{extra}', extra);
		$('#embed_preview iframe').attr('src', '/embed/' + id + extra);
		share_field.val(htm);
	}
})();
		</script>
	</div>
</section>